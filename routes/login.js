/*====================================================================================*/
/*  IMPORTACIONES
/*====================================================================================*/
const express = require('express');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const SEED = require('../config/config').SEED;
/*====================================================================================*/
/*  INICIALIZACIÓN DE VARIABLES
/*====================================================================================*/
const app = express();
/*====================================================================================*/
/*  IMPORTACIÓN DE MODELOS
/*====================================================================================*/
const User = require('../models/user');
/*====================================================================================*/
/*  DEFINICION DE RUTAS
/*====================================================================================*/
/*====================================================================================*/
/*  INICIO DE SESIÓN DEL USUARIO
/*====================================================================================*/
app.post('/', (request, response) => {
  /*----------------------------------------------------------------------------------*/
  /*  Se extrae el contenido de la petición.
  /*----------------------------------------------------------------------------------*/
  const body = request.body;
  /*----------------------------------------------------------------------------------*/
  /*  Se realiza la petición.
  /*----------------------------------------------------------------------------------*/
  User.findOne({ email: body.email }, (error, user) => {
    /*----------------------------------------------------------------------------------*/
    /*  Se maneja el error.
  /*----------------------------------------------------------------------------------*/
    if (error) {
      return response.status(500).json({
        ok: false,
        message: 'Error al obtener el usuario.',
        errors: error
      });
    }
    /*----------------------------------------------------------------------------------*/
    /*  Se verifica que el usuario exista.
  /*----------------------------------------------------------------------------------*/
    if (!user) {
      return response.status(400).json({
        ok: false,
        message: 'Las credenciales no son válidas.',
        errors: error
      });
    }
    /*----------------------------------------------------------------------------------*/
    /*  Se verifica que la contraseña coincida.
  /*----------------------------------------------------------------------------------*/
    if (bcrypt.compareSync(body.password, user.password)) {
      return response.status(400).json({
        ok: false,
        message: 'Las credenciales no son válidas.',
        errors: error
      });
    }
    /*----------------------------------------------------------------------------------*/
    /*  Se genera el token.
    /*----------------------------------------------------------------------------------*/
    const token = jwt.sign({ user: user }, SEED, { expiresIn: 3600 });
    /*----------------------------------------------------------------------------------*/
    /*  Se envía la respuesta de éxito.
    /*----------------------------------------------------------------------------------*/
    response.status(200).json({
      ok: true,
      user: user,
      token: token
    });
  });
});
/*====================================================================================*/
/*  EXPORTACIÓN DEL MODELO
/*====================================================================================*/
module.exports = app;
